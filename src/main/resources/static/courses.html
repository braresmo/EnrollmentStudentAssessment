<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Management - EduTech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-container, .table-container { transition: all 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Navigation -->
    <nav class="bg-white shadow-lg mb-6">
        <div class="container mx-auto px-6 py-3">
            <div class="flex items-center justify-between">
                <div class="text-xl font-bold text-indigo-600">
                    ðŸ“š Course Management
                </div>
                <div class="hidden md:flex space-x-6">
                    <a href="index.html" class="text-gray-700 hover:text-indigo-600 font-medium">Dashboard</a>
                    <a href="#" class="text-indigo-600 font-medium">Courses</a>
                    <a href="students.html" class="text-gray-700 hover:text-indigo-600 font-medium">Students</a>
                    <a href="instructors.html" class="text-gray-700 hover:text-indigo-600 font-medium">Instructors</a>
                    <a href="enrollments.html" class="text-gray-700 hover:text-indigo-600 font-medium">Enrollments</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        
        <!-- Instructor Filter Info (shown when filtering by specific instructor) -->
        <div id="instructor-filter-info" class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6 hidden">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-purple-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-purple-700">
                        <strong>Filtering:</strong> <span id="instructor-filter-name">Showing courses taught by selected instructor</span>
                    </p>
                </div>
                <div class="ml-auto">
                    <button id="clear-instructor-filter" class="text-purple-600 hover:text-purple-800 text-sm font-medium">
                        Show All Courses
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Form for Adding and Updating Courses -->
        <div id="form-container" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 id="form-title" class="text-2xl font-semibold mb-4 text-gray-700">Add New Course</h2>
            <form id="course-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="course-id">
                
                <div>
                    <label for="course-tenant-id" class="block text-sm font-medium text-gray-700">Tenant ID</label>
                    <input type="number" id="course-tenant-id" placeholder="e.g., 1" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>

                <div>
                    <label for="course-code" class="block text-sm font-medium text-gray-700">Course Code</label>
                    <input type="text" id="course-code" placeholder="e.g., CS101" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>

                <div class="md:col-span-2">
                    <label for="course-title" class="block text-sm font-medium text-gray-700">Course Title</label>
                    <input type="text" id="course-title" placeholder="e.g., Introduction to Computer Science" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>

                <div>
                    <label for="course-status" class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="course-status" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="">Select Status</option>
                        <option value="ACTIVE">Active</option>
                        <option value="INACTIVE">Inactive</option>
                        <option value="DRAFT">Draft</option>
                    </select>
                </div>

                <div>
                    <label for="course-instructor" class="block text-sm font-medium text-gray-700">Instructor</label>
                    <select id="course-instructor" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="">Select Instructor</option>
                    </select>
                </div>

                <div class="md:col-span-2 flex space-x-3">
                    <button type="submit" id="submit-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">
                        Add Course
                    </button>
                    <button type="button" id="cancel-btn" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200" style="display: none;">
                        Cancel
                    </button>
                </div>
            </form>
        </div>

        <!-- Search and Filters Section -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h3 class="text-lg font-semibold mb-4 text-gray-700">Search & Filter Courses</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div>
                    <label for="filter-code" class="block text-sm font-medium text-gray-700">Search by Code</label>
                    <input type="text" id="filter-code" placeholder="e.g., CS101" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="filter-title" class="block text-sm font-medium text-gray-700">Search by Title</label>
                    <input type="text" id="filter-title" placeholder="e.g., Programming" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="filter-status" class="block text-sm font-medium text-gray-700">Filter by Status</label>
                    <select id="filter-status" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="">All Statuses</option>
                        <option value="ACTIVE">Active</option>
                        <option value="DRAFT">Draft</option>
                        <option value="PUBLISHED">Published</option>
                        <option value="ARCHIVED">Archived</option>
                    </select>
                </div>
                <div>
                    <label for="filter-instructor" class="block text-sm font-medium text-gray-700">Filter by Instructor</label>
                    <select id="filter-instructor" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="">All Instructors</option>
                    </select>
                </div>
            </div>
            <div class="flex space-x-3">
                <button id="apply-filters-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-200">
                    Apply Filters
                </button>
                <button id="clear-filters-btn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200">
                    Clear Filters
                </button>
            </div>
        </div>

        <!-- Courses Table -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">All Courses</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 border-b border-gray-200 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                            <th class="px-6 py-3 border-b border-gray-200 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                            <th class="px-6 py-3 border-b border-gray-200 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 border-b border-gray-200 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Instructor</th>
                            <th class="px-6 py-3 border-b border-gray-200 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Published</th>
                            <th class="px-6 py-3 border-b border-gray-200 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="courses-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Course rows will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        let courses = [];
        let instructors = [];

        // Load instructors for dropdown
        async function loadInstructors() {
            try {
                const response = await fetch(`${API_BASE}/instructor/getAll`);
                if (response.ok) {
                    instructors = await response.json();
                    
                    // Populate course form dropdown
                    const select = document.getElementById('course-instructor');
                    select.innerHTML = '<option value="">Select Instructor</option>';
                    instructors.forEach(instructor => {
                        const option = document.createElement('option');
                        option.value = instructor.userId;
                        option.textContent = `${instructor.name} (${instructor.employeeNumber})`;
                        select.appendChild(option);
                    });

                    // Populate filter dropdown
                    const filterSelect = document.getElementById('filter-instructor');
                    filterSelect.innerHTML = '<option value="">All Instructors</option>';
                    instructors.forEach(instructor => {
                        const option = document.createElement('option');
                        option.value = instructor.userId;
                        option.textContent = `${instructor.name} (${instructor.employeeNumber})`;
                        filterSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading instructors:', error);
            }
        }

        // Load all courses
        async function loadCourses() {
            try {
                const response = await fetch(`${API_BASE}/course/getAll`);
                if (response.ok) {
                    courses = await response.json();
                    displayCourses();
                } else {
                    console.error('Failed to load courses');
                }
            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }

        // Display courses in table
        function displayCourses() {
            const tbody = document.getElementById('courses-table-body');
            tbody.innerHTML = '';

            courses.forEach(course => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const instructorName = course.instructor ? course.instructor.name : 'Not Assigned';
                const publishedDate = new Date(course.publishedAt).toLocaleDateString();
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${course.code}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${course.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(course.status)}">
                            ${course.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${instructorName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${publishedDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editCourse(${course.idCourse})" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                        <button onclick="deleteCourse(${course.idCourse})" class="text-red-600 hover:text-red-900 mr-3">Delete</button>
                        <a href="modules.html?courseId=${course.idCourse}" class="text-green-600 hover:text-green-900 mr-3">Modules</a>
                        <a href="enrollments.html?courseId=${course.idCourse}" class="text-yellow-600 hover:text-yellow-900">View Enrollments</a>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Get status color for badge
        function getStatusColor(status) {
            switch (status) {
                case 'ACTIVE': return 'bg-green-100 text-green-800';
                case 'INACTIVE': return 'bg-red-100 text-red-800';
                case 'DRAFT': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Filter functions
        async function applyFilters() {
            const code = document.getElementById('filter-code').value.trim();
            const title = document.getElementById('filter-title').value.trim();
            const status = document.getElementById('filter-status').value;
            const instructorId = document.getElementById('filter-instructor').value;

            try {
                let response;
                
                // If no filters are applied, load all courses
                if (!code && !title && !status && !instructorId) {
                    response = await fetch(`${API_BASE}/course/getAll`);
                } else {
                    // Build query parameters
                    const params = new URLSearchParams();
                    if (code) params.append('code', code);
                    if (title) params.append('title', title);
                    if (status) params.append('status', status);
                    if (instructorId) params.append('instructorId', instructorId);
                    
                    response = await fetch(`${API_BASE}/course/findWithFilters?${params.toString()}`);
                }

                if (response.ok) {
                    courses = await response.json();
                    displayCourses();
                } else {
                    console.error('Failed to apply filters');
                }
            } catch (error) {
                console.error('Error applying filters:', error);
            }
        }

        function clearFilters() {
            document.getElementById('filter-code').value = '';
            document.getElementById('filter-title').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-instructor').value = '';
            loadCourses(); // Reload all courses
        }

        // Add or update course
        document.getElementById('course-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const courseData = {
                idTenant: parseInt(document.getElementById('course-tenant-id').value),
                code: document.getElementById('course-code').value,
                title: document.getElementById('course-title').value,
                status: document.getElementById('course-status').value,
                publishedAt: new Date().toISOString(),
                instructor: {
                    userId: parseInt(document.getElementById('course-instructor').value)
                }
            };

            const courseId = document.getElementById('course-id').value;
            
            try {
                let response;
                if (courseId) {
                    // Update course
                    courseData.idCourse = parseInt(courseId);
                    response = await fetch(`${API_BASE}/course/update`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(courseData)
                    });
                } else {
                    // Add new course
                    response = await fetch(`${API_BASE}/course/save`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(courseData)
                    });
                }

                if (response.ok) {
                    resetForm();
                    loadCourses();
                    alert(courseId ? 'Course updated successfully!' : 'Course added successfully!');
                } else {
                    alert('Error saving course. Please try again.');
                }
            } catch (error) {
                console.error('Error saving course:', error);
                alert('Error saving course. Please try again.');
            }
        });

        // Edit course
        function editCourse(courseId) {
            const course = courses.find(c => c.idCourse === courseId);
            if (course) {
                document.getElementById('course-id').value = course.idCourse;
                document.getElementById('course-tenant-id').value = course.idTenant;
                document.getElementById('course-code').value = course.code;
                document.getElementById('course-title').value = course.title;
                document.getElementById('course-status').value = course.status;
                document.getElementById('course-instructor').value = course.instructor ? course.instructor.userId : '';
                
                document.getElementById('form-title').textContent = 'Edit Course';
                document.getElementById('submit-btn').textContent = 'Update Course';
                document.getElementById('cancel-btn').style.display = 'inline-block';
            }
        }

        // Delete course
        async function deleteCourse(courseId) {
            if (confirm('Are you sure you want to delete this course? This action cannot be undone.')) {
                try {
                    const response = await fetch(`${API_BASE}/course/delete/${courseId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        loadCourses();
                        alert('Course deleted successfully!');
                    } else {
                        alert('Error deleting course. Please try again.');
                    }
                } catch (error) {
                    console.error('Error deleting course:', error);
                    alert('Error deleting course. Please try again.');
                }
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('course-form').reset();
            document.getElementById('course-id').value = '';
            document.getElementById('form-title').textContent = 'Add New Course';
            document.getElementById('submit-btn').textContent = 'Add Course';
            document.getElementById('cancel-btn').style.display = 'none';
        }

        // Cancel edit
        document.getElementById('cancel-btn').addEventListener('click', resetForm);

        // Filter event listeners
        document.getElementById('apply-filters-btn').addEventListener('click', applyFilters);
        document.getElementById('clear-filters-btn').addEventListener('click', clearFilters);

        // Add real-time search functionality (optional)
        document.getElementById('filter-code').addEventListener('input', debounce(applyFilters, 500));
        document.getElementById('filter-title').addEventListener('input', debounce(applyFilters, 500));
        document.getElementById('filter-status').addEventListener('change', applyFilters);
        document.getElementById('filter-instructor').addEventListener('change', function() {
            const instructorId = this.value;
            if (instructorId) {
                showInstructorFilterInfo(instructorId);
                // Update page title
                setTimeout(() => {
                    const instructorName = getInstructorName(instructorId);
                    document.querySelector('h2').textContent = instructorName ? `Courses taught by ${instructorName}` : `Courses by Instructor ID: ${instructorId}`;
                }, 100);
            } else {
                document.getElementById('instructor-filter-info').classList.add('hidden');
                document.querySelector('h2').textContent = 'All Courses';
            }
            applyFilters();
        });

        // Debounce function for real-time search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Get URL parameters
        function getURLParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Show instructor filter information
        function showInstructorFilterInfo(instructorId) {
            const instructorName = getInstructorName(instructorId);
            const displayName = instructorName || `Instructor ID: ${instructorId}`;
            
            document.getElementById('instructor-filter-name').textContent = `Showing courses taught by ${displayName}`;
            document.getElementById('instructor-filter-info').classList.remove('hidden');
        }

        // Helper function to get instructor name by ID
        function getInstructorName(instructorId) {
            // Get instructor name from instructor dropdown
            const instructorSelect = document.getElementById('course-instructor');
            const option = instructorSelect.querySelector(`option[value="${instructorId}"]`);
            return option ? option.textContent : null;
        }

        // Clear all filters function
        function clearAllFilters() {
            // Clear all filter dropdowns
            document.getElementById('filter-code').value = '';
            document.getElementById('filter-title').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-instructor').value = '';
            
            // Hide filter info banner
            document.getElementById('instructor-filter-info').classList.add('hidden');
            
            // Reset page title
            document.querySelector('h2').textContent = 'All Courses';
            document.title = 'Course Management - EduTech';
            
            // Clear form selections
            document.getElementById('course-instructor').value = '';
            
            // Reload all courses
            loadCourses();
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadInstructors();
            loadCourses();
            
            // Check for URL parameters on page load
            const instructorId = getURLParameter('instructorId');
            if (instructorId) {
                console.log('Filtering by instructor ID:', instructorId);
                // Wait for data to load, then apply filter
                setTimeout(() => {
                    // Pre-select the instructor in the dropdown
                    document.getElementById('course-instructor').value = instructorId;
                    // Pre-select the instructor in the filter
                    document.getElementById('filter-instructor').value = instructorId;
                    // Apply the filter
                    applyFilters();
                    
                    // Show the filter info banner
                    showInstructorFilterInfo(instructorId);
                    
                    // Update page title to show filtering
                    const pageTitle = document.querySelector('h2');
                    if (pageTitle) {
                        const instructorName = getInstructorName(instructorId);
                        pageTitle.textContent = instructorName ? `Courses taught by ${instructorName}` : `Courses by Instructor ID: ${instructorId}`;
                    }
                }, 500); // Wait for dropdowns to be populated
            }
            
            // Clear instructor filter button functionality
            document.getElementById('clear-instructor-filter').addEventListener('click', clearAllFilters);
        });
    </script>
</body>
</html>